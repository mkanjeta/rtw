name: Build ffmpeg-kit LTS (Debug cpu-features)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (example: n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Install required tools
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential automake autoconf \
          libtool pkg-config openjdk-17-jdk python3

    - name: Download Android NDK r25c
      run: |
        mkdir -p "$HOME/ndk"
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r25c "$HOME/ndk/"

    - name: Clone ffmpeg-kit repo
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive || true

    - name: Clone FFmpeg LTS source
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        if [ -z "$TAG" ]; then TAG="n6.0"; fi
        mkdir ffmpeg-kit/prebuilt
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-kit/prebuilt/ffmpeg

    - name: Debug build (capture cpu-features errors)
      run: |
        set -euo pipefail

        cd ffmpeg-kit

        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r25c"
        export ANDROID_NDK_HOME="$ANDROID_NDK_ROOT"
        export NDK_HOME="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_NDK_ROOT:$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

        echo "===== VERIFY NDK PATH ====="
        echo "NDK: $ANDROID_NDK_ROOT"
        ls -la "$ANDROID_NDK_ROOT" || true
        echo "===== NDK android sources ====="
        ls -la "$ANDROID_NDK_ROOT/sources/android" || true

        echo "===== Check ndk-build ====="
        ls -la "$ANDROID_NDK_ROOT/ndk-build" || true

        chmod -R a+rX "$ANDROID_NDK_ROOT"

        echo "===== STARTING ANDROID.SH ====="
        set +e
        FFMPEG_SOURCE_DIR="$(pwd)/prebuilt/ffmpeg" \
        ./android.sh \
          --lts \
          --enable-gpl \
          --disable-x86 \
          --disable-x86-64 \
          --disable-arm-v7a-neon \
          --no-ffmpeg-kit-protocols \
          2>&1 | tee android-sh-output.txt
        EXITCODE=$?
        set -e

        echo "===== android.sh exit code: $EXITCODE ====="
        echo "===== tail of android-sh-output.txt ====="
        tail -n 200 android-sh-output.txt || true

        echo "===== FINDING build.log ====="
        if [ -f build.log ]; then
          echo "build.log found at ffmpeg-kit/build.log"
          tail -n 400 build.log
        else
          echo "Searching recursively:"
          find . -type f -name build.log -print -exec tail -n 200 {} \; || true
        fi

        echo "===== TESTING cpufeatures manually ====="
        CPUF="$ANDROID_NDK_ROOT/sources/android/cpufeatures"
        if [ -d "$CPUF" ]; then
          echo "cpufeatures folder exists â†’ running ndk-build directly"
          cd "$CPUF"

          rm -rf obj libs || true

          set +e
          "$ANDROID_NDK_ROOT/ndk-build" V=1 2>&1 | tee /tmp/cpufeatures-ndk-build.txt
          NDK_RC=$?
          set -e

          echo "===== ndk-build exit code: $NDK_RC ====="
          tail -n 200 /tmp/cpufeatures-ndk-build.txt || true

          echo "===== cpufeatures obj/libs content ====="
          find . -maxdepth 3 -type d -exec ls -la {} \; || true
        else
          echo "ERROR: cpufeatures folder missing!"
          ls -la "$ANDROID_NDK_ROOT/sources/android" || true
        fi

        exit $EXITCODE
