name: Build ffmpeg-kit (ffmpeg_min_gpl LTS) â€” Mobile ABIs (arm64 + armv7)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (example: n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Install required tools
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential pkg-config automake autoconf libtool openjdk-17-jdk zip python3

    - name: Download Android NDK r26d
      run: |
        mkdir -p "$HOME/ndk"
        wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-*/* "$HOME/ndk/"

    - name: Clone ffmpeg-kit
      run: |
        git clone --depth 1 https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive || true

    - name: Clone FFmpeg LTS
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        if [ -z "$TAG" ]; then TAG="n6.0"; fi
        echo "Using FFmpeg tag: $TAG"
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-src

    - name: Build FFmpeg (arm64-v8a + armeabi-v7a)
      run: |
        set -euo pipefail

        export NDK="$HOME/ndk"
        TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64"
        API=21

        FFMPEG_SRC="$(pwd)/ffmpeg-src"
        OUT_ROOT="$HOME/ffout"
        mkdir -p "$OUT_ROOT"

        ABIS="arm64-v8a armeabi-v7a"

        for ABI in $ABIS; do
          echo "==== Building $ABI ===="

          if [ "$ABI" = "arm64-v8a" ]; then
            ARCH=aarch64
            CPU=armv8-a
            CC="$TOOLCHAIN/bin/aarch64-linux-android${API}-clang"
            AR="$TOOLCHAIN/bin/aarch64-linux-android-ar"
            RANLIB="$TOOLCHAIN/bin/aarch64-linux-android-ranlib"
            EXTRA_CFLAGS="-fPIC"

          elif [ "$ABI" = "armeabi-v7a" ]; then
            ARCH=arm
            CPU=armv7-a
            CC="$TOOLCHAIN/bin/armv7a-linux-androideabi${API}-clang"
            AR="$TOOLCHAIN/bin/arm-linux-androideabi-ar"
            RANLIB="$TOOLCHAIN/bin/arm-linux-androideabi-ranlib"
            EXTRA_CFLAGS="-fPIC -mfloat-abi=softfp -mfpu=neon -march=armv7-a"
          fi

          BUILD_DIR="$(pwd)/ffmpeg-build-$ABI"
          PREFIX="$OUT_ROOT/$ABI"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cp -r "$FFMPEG_SRC" "$BUILD_DIR/ffmpeg"
          cd "$BUILD_DIR/ffmpeg"

          ./configure \
            --prefix="$PREFIX" \
            --target-os=android \
            --arch="$ARCH" \
            --cpu="$CPU" \
            --enable-cross-compile \
            --cc="$CC" \
            --ar="$AR" \
            --ranlib="$RANLIB" \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --disable-stripping \
            --enable-gpl \
            --disable-vulkan \
            --extra-cflags="$EXTRA_CFLAGS" \
            --extra-ldflags="-Wl,-z,max-page-size=16384"

          make -j$(nproc)
          make install
          cd "$(pwd -P)/../../"
        done

        echo "=== Done building FFmpeg ==="
        echo "=== arm64-v8a output ==="
        ls -la $HOME/ffout/arm64-v8a/lib
        echo "=== armeabi-v7a output ==="
        ls -la $HOME/ffout/armeabi-v7a/lib

    - name: Copy native libs into ffmpeg-kit module
      run: |
        set -euo pipefail
        MODULE="ffmpeg-kit/android/ffmpeg-kit-android-lib"
        LIBROOT="ffmpeg-kit/android/libs"

        echo "Module: $MODULE"
        echo "Libroot: $LIBROOT"

        mkdir -p "$LIBROOT/arm64-v8a"
        mkdir -p "$LIBROOT/armeabi-v7a"

        cp -v "$HOME/ffout/arm64-v8a/lib/"*.so "$LIBROOT/arm64-v8a/"
        cp -v "$HOME/ffout/armeabi-v7a/lib/"*.so "$LIBROOT/armeabi-v7a/"

        echo "=== libs content ==="
        find "$LIBROOT" -type f -print
        
    - name: Show ffmpeg-kit-android-lib/build.gradle
      run: |
        cat ffmpeg-kit/android/ffmpeg-kit-android-lib/build.gradle


    - name: Build ffmpeg-kit AAR
      run: |
        set -euo pipefail
        cd ffmpeg-kit/android
        chmod +x gradlew
        ./gradlew :ffmpeg-kit-android-lib:assembleRelease --no-daemon --stacktrace

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-min-gpl-mobile-16kb-aar
        path: ffmpeg-kit/android/ffmpeg-kit-android-lib/build/outputs/aar/ffmpeg-kit-release.aar
