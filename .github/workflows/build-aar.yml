name: Build ffmpeg-kit LTS (patched cpu-features)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (example: n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - name: Install required tools
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential automake autoconf \
          libtool pkg-config openjdk-17-jdk python3 cmake

    - name: Download Android NDK r25c
      run: |
        mkdir -p "$HOME/ndk"
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r25c "$HOME/ndk/"

    - name: Clone ffmpeg-kit repo
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        # ensure submodules are fetched; fail early if this fails
        git submodule update --init --recursive

    - name: Clone FFmpeg LTS source
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        [ -z "$TAG" ] && TAG="n6.0"
        mkdir -p ffmpeg-kit/prebuilt
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-kit/prebuilt/ffmpeg

    - name: Patch cpu-features CMakeLists for modern CMake
      run: |
        set -euo pipefail
        cd ffmpeg-kit

        CPUF_SRC="src/cpu-features"
        CMAKEFILE="$CPUF_SRC/CMakeLists.txt"

        if [ -f "$CMAKEFILE" ]; then
          echo "Found $CMAKEFILE — patching to require modern CMake (>=3.5)"
          # If file already contains cmake_minimum_required, replace its VERSION with 3.5
          # Otherwise, insert cmake_minimum_required(VERSION 3.5) at top.
          if grep -q "cmake_minimum_required" "$CMAKEFILE"; then
            # replace first cmake_minimum_required line with a modern version
            awk 'BEGIN{patched=0}
              {
                if(!patched && tolower($0) ~ /cmake_minimum_required/){
                  print "cmake_minimum_required(VERSION 3.5)"
                  patched=1
                } else {
                  print $0
                }
              }
            ' "$CMAKEFILE" > "$CMAKEFILE.patched" && mv "$CMAKEFILE.patched" "$CMAKEFILE"
          else
            # insert a modern cmake_minimum_required at top
            sed -i '1i cmake_minimum_required(VERSION 3.5)\n' "$CMAKEFILE"
          fi

          echo "Patched — head of $CMAKEFILE:"
          sed -n '1,40p' "$CMAKEFILE" || true
        else
          echo "Warning: $CMAKEFILE not present (unexpected). Skipping patch."
        fi

    - name: Run android.sh build (LTS, GPL, armv7 + arm64) and capture logs
      run: |
        set -euo pipefail
        cd ffmpeg-kit

        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r25c"
        export ANDROID_NDK_HOME="$ANDROID_NDK_ROOT"
        export NDK_HOME="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_NDK_ROOT:$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

        echo "NDK path: $ANDROID_NDK_ROOT"
        ls -la "$ANDROID_NDK_ROOT" || true
        ls -la "$ANDROID_NDK_ROOT/sources/android" || true

        # run android.sh and capture full output
        set +e
        FFMPEG_SOURCE_DIR="$(pwd)/prebuilt/ffmpeg" \
        ./android.sh \
          --lts \
          --enable-gpl \
          --disable-x86 \
          --disable-x86-64 \
          --disable-arm-v7a-neon \
          --no-ffmpeg-kit-protocols \
          2>&1 | tee android-sh-output.txt
        EXITCODE=$?
        set -e

        echo "android.sh exit code: $EXITCODE"

        # Save build log(s)
        if [ -f build.log ]; then
          echo "build.log found — copying to artifacts dir"
          mkdir -p ../artifacts
          cp build.log ../artifacts/build.log
        else
          echo "No build.log at top-level; searching recursively..."
          find . -type f -name build.log -print -exec sh -c 'mkdir -p ../artifacts/$(dirname "{}") && cp "{}" "../artifacts/{}"' \;
        fi

        # always copy android.sh stdout captured
        cp android-sh-output.txt ../artifacts/android-sh-output.txt || true

        # Also capture any cpu-features ndk-build output if present
        CPUF="$ANDROID_NDK_ROOT/sources/android/cpufeatures"
        if [ -d "$CPUF" ]; then
          # run ndk-build in cpufeatures to produce trace if needed (don't fail step on this)
          set +e
          (cd "$CPUF" && "$ANDROID_NDK_ROOT/ndk-build" V=1) > ../artifacts/cpufeatures-ndk-build.txt 2>&1 || true
          set -e
        fi

        # Upload artifacts directory via actions/upload-artifact step below
        # finally exit with the android.sh exit code so the job marks fail/success correctly
        exit $EXITCODE

    - name: Upload build artifacts (logs)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-build-logs
        path: artifacts
