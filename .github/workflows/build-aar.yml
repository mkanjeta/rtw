name: Build ffmpeg-kit-min-gpl AAR (mobile ABIs, 16KB)

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (e.g. n6.0)"
        required: false
        default: "n6.0"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: ${{ runner.workspace }}/android-sdk
      NDK_ZIP_URL: "https://dl.google.com/android/repository/android-ndk-r26d-linux.zip"

    steps:

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip git openjdk-17-jdk build-essential pkg-config autoconf automake libtool yasm nasm zip

      - name: Install Android SDK
        run: |
          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools"
          cd "${ANDROID_SDK_ROOT}"
          curl -L -o tools.zip "https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip"
          unzip -q tools.zip -d cmdline-tools-temp
          mkdir cmdline-tools/latest
          mv cmdline-tools-temp/cmdline-tools/* cmdline-tools/latest/
          yes | cmdline-tools/latest/bin/sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Download Android NDK r26d
        run: |
          mkdir -p $HOME/ndk
          curl -L -o ndk.zip "$NDK_ZIP_URL"
          unzip -q ndk.zip -d $HOME
          mv $HOME/android-ndk-*/* $HOME/ndk/
          echo "ndk.dir=$HOME/ndk" > ffmpeg-kit/android/local.properties
          echo "sdk.dir=${ANDROID_SDK_ROOT}" >> ffmpeg-kit/android/local.properties

      - name: Clone ffmpeg-kit
        run: |
          git clone --depth 1 https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
          cd ffmpeg-kit
          git submodule update --init --recursive || true

      - name: Clone FFmpeg source
        run: |
          TAG="${{ github.event.inputs.ffmpeg_tag }}"
          if [ -z "$TAG" ]; then TAG="n6.0"; fi
          git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-kit/ffmpeg

      - name: Build ffmpeg-kit with 16KB alignment
        run: |
          cd ffmpeg-kit
          chmod +x android.sh
          export ANDROID_NDK_HOME="$HOME/ndk"
          export ANDROID_HOME="${ANDROID_SDK_ROOT}"
          export PATH="$HOME/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          export EXTRA_LDFLAGS="-Wl,-z,max-page-size=16384"
          ./android.sh --enable-gpl --api-21 --android-abis="arm64-v8a armeabi-v7a"

      - name: Build AAR
        run: |
          cd ffmpeg-kit/android
          chmod +x ./gradlew
          ./gradlew :ffmpeg-kit-android-lib:assembleRelease --no-daemon --stacktrace

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-min-gpl-16kb-aar
          path: ffmpeg-kit/android/ffmpeg-kit-android-lib/build/outputs/aar/ffmpeg-kit-release.aar
