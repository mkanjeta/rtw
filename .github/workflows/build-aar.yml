name: Build ffmpeg-kit (FFmpeg LTS min-gpl) â€“ Mobile ABIs

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (e.g., n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential \
          automake autoconf libtool pkg-config openjdk-17-jdk python3

    - name: Download Android NDK r26d
      run: |
        mkdir -p "$HOME/ndk"
        wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-* "$HOME/ndk/android-ndk-r26d"

    - name: Clone ffmpeg-kit
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive

    - name: Clone FFmpeg LTS
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        [ -z "$TAG" ] && TAG="n6.0"
        echo "Using FFmpeg LTS: $TAG"
        mkdir ffmpeg-kit/prebuilt
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-kit/prebuilt/ffmpeg

    - name: Build ffmpeg-kit with custom FFmpeg LTS
      run: |
        set -e
        cd ffmpeg-kit

        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r26d"
        
        ./android.sh ffmpeg \
          --enable-gpl \
          --enable-lts \
          --disable-vulkan \
          --enable-arm64 \
          --enable-armv7 \
          --ffmpeg-source-dir="$(pwd)/prebuilt/ffmpeg"

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-lts-min-gpl-aar
        path: ffmpeg-kit/prebuilt/android-aar/*.aar
