name: Build ffmpeg-kit (LTS) – arm64 + armv7 – 16KB Pagesize

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 200

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential yasm nasm cmake git \
          autoconf automake libtool pkg-config unzip \
          openjdk-17-jdk python3

    - name: Download Android NDK r21e (API 16 compatible)
      run: |
        mkdir -p $HOME/ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r21e $HOME/ndk/

    - name: Clone ffmpeg-kit
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive

    - name: Patch cpu-features CMakeLists for modern CMake
      run: |
        set -e
        CPUF="ffmpeg-kit/src/cpu-features"

        if [ -f "$CPUF/CMakeLists.txt" ]; then
          echo "Patching cpu-features CMakeLists.txt..."
          # Force minimum cmake version
          sed -i '1s/.*/cmake_minimum_required(VERSION 3.5)/' "$CPUF/CMakeLists.txt"

          # Remove old policy version lines
          sed -i '/CMAKE_POLICY_VERSION/d' "$CPUF/CMakeLists.txt"
        fi

    - name: Inject 16KB page-size flags into ffmpeg-kit scripts
      run: |
        FLAG="-Wl,-z,max-page-size=16384"

        sed -i "1a export LDFLAGS=\"\$LDFLAGS $FLAG\"" ffmpeg-kit/android.sh
        sed -i "1a export EXTRA_LDFLAGS=\"\$EXTRA_LDFLAGS $FLAG\"" ffmpeg-kit/android.sh
        sed -i "1a export FFMPEG_EXTRA_LDFLAGS=\"\$FFMPEG_EXTRA_LDFLAGS $FLAG\"" ffmpeg-kit/android.sh

    - name: Build ffmpeg-kit LTS native libs
      run: |
        set -e
        cd ffmpeg-kit

        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r21e"
        export PATH="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

        set +e
        ./android.sh \
          --lts \
          --enable-gpl \
          --disable-x86 \
          --disable-x86-64 \
          --no-ffmpeg-kit-protocols \
          2>&1 | tee android-build.log
        CODE=$?
        set -e

        cp android-build.log ../android-build.log

        if [ $CODE -ne 0 ]; then
          echo "Native build failed"
          exit 1
        fi

    - name: Build AAR
      run: |
        cd ffmpeg-kit/android
        chmod +x gradlew
        ./gradlew :ffmpeg-kit-android-lib:assembleRelease --no-daemon --stacktrace

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-lts-aar
        path: ffmpeg-kit/android/ffmpeg-kit-android-lib/build/outputs/aar/*.aar

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: android-build.log
