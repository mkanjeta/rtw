name: Build ffmpeg-kit (ffmpeg_min_gpl LTS) with 16KB FFmpeg

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (example: n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential pkg-config automake autoconf libtool openjdk-17-jdk zip python3

    - name: Download Android NDK r26d
      run: |
        mkdir -p $HOME/ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-*/* $HOME/ndk/

    - name: Clone ffmpeg-kit
      run: |
        git clone --depth 1 https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive || true

    - name: Clone FFmpeg LTS
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        if [ -z "$TAG" ]; then TAG="n6.0"; fi
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-src

    - name: Build FFmpeg arm64-v8a with 16KB alignment
      run: |
        set -euo pipefail
        export NDK=$HOME/ndk
        TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        API=21

        ABI="arm64-v8a"
        ARCH="aarch64"
        CPU="armv8-a"

        CC=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang
        AR=$TOOLCHAIN/bin/aarch64-linux-android-ar
        RANLIB=$TOOLCHAIN/bin/aarch64-linux-android-ranlib

        mkdir -p ffbuild
        cp -r ffmpeg-src ffbuild/ffmpeg
        cd ffbuild/ffmpeg

        ./configure \
          --prefix="$HOME/ffout/arm64-v8a" \
          --target-os=android \
          --arch="$ARCH" \
          --cpu="$CPU" \
          --enable-cross-compile \
          --cc="$CC" \
          --ar="$AR" \
          --ranlib="$RANLIB" \
          --enable-shared \
          --disable-static \
          --disable-programs \
          --disable-doc \
          --disable-stripping \
          --enable-gpl \
          --disable-vulkan \
          --extra-cflags="-fPIC" \
          --extra-ldflags="-Wl,-z,max-page-size=16384"

        make -j$(nproc)
        make install

    - name: Copy libs into ffmpeg-kit Android module
      run: |
        set -euo pipefail
        MODULE="ffmpeg-kit/android/ffmpeg-kit-android-lib"

        mkdir -p "$MODULE/src/main/jniLibs/arm64-v8a"
        cp -v $HOME/ffout/arm64-v8a/lib/*.so "$MODULE/src/main/jniLibs/arm64-v8a/"

        echo "Native libs copied successfully."

    - name: Build ffmpeg-kit AAR
      run: |
        cd ffmpeg-kit/android
        chmod +x ./gradlew
        ./gradlew :ffmpeg-kit-android-lib:assembleRelease --no-daemon --stacktrace

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-min-gpl-16kb-aar
        path: ffmpeg-kit/android/ffmpeg-kit-android-lib/build/outputs/aar/ffmpeg-kit-android-lib-release.aar
