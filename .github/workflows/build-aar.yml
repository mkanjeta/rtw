name: Build ffmpeg-kit (LTS) – arm64 + armv7 – 16KB Pagesize

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 200

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential yasm nasm cmake git \
          autoconf automake libtool pkg-config unzip \
          openjdk-17-jdk python3

    - name: Download Android NDK r21e (API 16 compatible)
      run: |
        mkdir -p $HOME/ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r21e $HOME/ndk/

    - name: Clone ffmpeg-kit
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive

    - name: Force-use NDK cpufeatures (disable git download)
      run: |
        set -e
        cd ffmpeg-kit
    
        CPU_DIR="src/cpu-features"
        NDK_CPU_DIR="$HOME/ndk/android-ndk-r21e/sources/android/cpufeatures"
    
        echo "Replacing ffmpeg-kit cpu-features with NDK version..."
        rm -rf "$CPU_DIR"
        mkdir -p src
        cp -r "$NDK_CPU_DIR" "$CPU_DIR"
    
        # Patch function-android.sh to disable cpu-features git clone
        sed -i '/cpu-features/,/fi/{/download_library_source/s/^/#/}' scripts/function-android.sh
    
        echo "Patched ffmpeg-kit to use NDK cpu-features only"


    - name: Patch cpu-features CMakeLists for modern CMake
      run: |
        set -e
        CPUF="ffmpeg-kit/src/cpu-features"

        if [ -f "$CPUF/CMakeLists.txt" ]; then
          echo "Patching cpu-features CMakeLists.txt..."
          # Force minimum cmake version
          sed -i '1s/.*/cmake_minimum_required(VERSION 3.5)/' "$CPUF/CMakeLists.txt"

          # Remove old policy version lines
          sed -i '/CMAKE_POLICY_VERSION/d' "$CPUF/CMakeLists.txt"
        fi

    - name: Inject 16KB page-size flags into ffmpeg-kit scripts
      run: |
        FLAG="-Wl,-z,max-page-size=16384"

        sed -i "1a export LDFLAGS=\"\$LDFLAGS $FLAG\"" ffmpeg-kit/android.sh
        sed -i "1a export EXTRA_LDFLAGS=\"\$EXTRA_LDFLAGS $FLAG\"" ffmpeg-kit/android.sh
        sed -i "1a export FFMPEG_EXTRA_LDFLAGS=\"\$FFMPEG_EXTRA_LDFLAGS $FLAG\"" ffmpeg-kit/android.sh

    - name: Prepare NDK cpufeatures + build ffmpeg-kit (fix cpu-features)
      run: |
        set -euo pipefail
        cd ffmpeg-kit
    
        # explicit NDK (use r21e; change if you installed elsewhere)
        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r21e"
        export ANDROID_NDK_HOME="$ANDROID_NDK_ROOT"
        export NDK_HOME="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
    
        echo "NDK root: $ANDROID_NDK_ROOT"
        ls -la "$ANDROID_NDK_ROOT" | sed -n '1,120p' || true
    
        # 1) Remove ffmpeg-kit's downloaded cpu-features (if any)
        if [ -d src/cpu-features ]; then
          echo "Removing bundled cpu-features..."
          rm -rf src/cpu-features
        fi
    
        # 2) Copy cpufeatures from NDK to ffmpeg-kit src
        echo "Copying NDK cpufeatures into ffmpeg-kit/src/cpu-features ..."
        cp -r "$ANDROID_NDK_ROOT/sources/android/cpufeatures" src/cpu-features
        # confirm files
        ls -la src/cpu-features || true
    
        # 3) Ensure ndk-build is accessible and executable
        ls -la "$ANDROID_NDK_ROOT/ndk-build" || true
        chmod +x "$ANDROID_NDK_ROOT/ndk-build" || true
    
        # 4) Inject 16KB page-size into environment so all child builds inherit it
        PAGEFLAG='-Wl,-z,max-page-size=16384'
        export LDFLAGS="${LDFLAGS:-} $PAGEFLAG"
        export EXTRA_LDFLAGS="${EXTRA_LDFLAGS:-} $PAGEFLAG"
        export FFMPEG_EXTRA_LDFLAGS="${FFMPEG_EXTRA_LDFLAGS:-} $PAGEFLAG"
        echo "Injected LDFLAGS=$LDFLAGS"
    
        # 5) Run android.sh but capture everything to files so we can inspect
        set +e
        FFMPEG_SOURCE_DIR="$(pwd)/prebuilt/ffmpeg" \
        ./android.sh \
          --lts \
          --enable-gpl \
          --disable-x86 \
          --disable-x86-64 \
          --disable-arm-v7a-neon \
          --no-ffmpeg-kit-protocols \
          2>&1 | tee android-sh-output.txt
        RET=$?
        set -e
    
        echo "android.sh exit code: $RET"
        echo "----- tail android-sh-output.txt -----"
        tail -n 300 android-sh-output.txt || true
    
        # 6) Collect build.log(s) and cpufeatures ndk-build output if present
        mkdir -p ../artifacts || true
        cp android-sh-output.txt ../artifacts/android-sh-output.txt || true
    
        if [ -f build.log ]; then
          cp build.log ../artifacts/build.log || true
          echo "Saved build.log"
        else
          echo "No top-level build.log; searching..."
          find . -type f -name build.log -print -exec sh -c 'mkdir -p ../artifacts/$(dirname "{}") && cp "{}" "../artifacts/{}"' \; || true
        fi
    
        # Run ndk-build manually in cpufeatures to capture raw output (non-fatal)
        CPUF_SRC="$ANDROID_NDK_ROOT/sources/android/cpufeatures"
        if [ -d "$CPUF_SRC" ]; then
          echo "Running cpufeatures ndk-build directly for debug..."
          (cd "$CPUF_SRC" && "$ANDROID_NDK_ROOT/ndk-build" V=1) > ../artifacts/cpufeatures-ndk-build.txt 2>&1 || true
        fi
    
        # 7) Exit with android.sh result so job reflects success/fail
        exit $RET

    - name: Build AAR
      run: |
        cd ffmpeg-kit/android
        chmod +x gradlew
        ./gradlew :ffmpeg-kit-android-lib:assembleRelease --no-daemon --stacktrace

    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-lts-aar
        path: ffmpeg-kit/android/ffmpeg-kit-android-lib/build/outputs/aar/*.aar

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: android-build.log
