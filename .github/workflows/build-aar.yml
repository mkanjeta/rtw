name: Build ffmpeg-kit (FFmpeg LTS min-gpl) â€“ Mobile ABIs

on:
  workflow_dispatch:
    inputs:
      ffmpeg_tag:
        description: "FFmpeg LTS tag (e.g., n6.0)"
        default: "n6.0"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y yasm nasm unzip git build-essential \
          automake autoconf libtool pkg-config openjdk-17-jdk python3

    - name: Download Android NDK r25c
      run: |
        mkdir -p "$HOME/ndk"
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r25c "$HOME/ndk/"
    


    - name: Clone ffmpeg-kit
      run: |
        git clone https://github.com/arthenica/ffmpeg-kit ffmpeg-kit
        cd ffmpeg-kit
        git submodule update --init --recursive

    - name: Clone FFmpeg LTS
      run: |
        TAG="${{ github.event.inputs.ffmpeg_tag }}"
        [ -z "$TAG" ] && TAG="n6.0"
        echo "Using FFmpeg LTS: $TAG"
        mkdir ffmpeg-kit/prebuilt
        git clone --depth 1 --branch "$TAG" https://github.com/FFmpeg/FFmpeg ffmpeg-kit/prebuilt/ffmpeg

    - name: Build ffmpeg-kit with custom FFmpeg LTS
      run: |
        set -e
        cd ffmpeg-kit
    
        export ANDROID_NDK_ROOT="$HOME/ndk/android-ndk-r25c"
        export ANDROID_NDK_HOME="$ANDROID_NDK_ROOT"
        export NDK_HOME="$ANDROID_NDK_ROOT"
    
        echo "NDK path is:"
        echo $ANDROID_NDK_ROOT
        ls $ANDROID_NDK_ROOT/sources/android
    
        FFMPEG_SOURCE_DIR="$(pwd)/prebuilt/ffmpeg" \
        ./android.sh \
          --lts \
          --enable-gpl \
          --disable-x86 \
          --disable-x86-64 \
          --disable-arm-v7a-neon \
          --no-ffmpeg-kit-protocols




    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-kit-lts-min-gpl-aar
        path: ffmpeg-kit/prebuilt/android-aar/*.aar
